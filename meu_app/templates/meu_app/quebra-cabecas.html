{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quebra-Cabe√ßa - Acervo Art√≠stico</title>
    
    <link rel="stylesheet" href="{% static 'meu_app/css/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Stick+No+Bills:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* ---------------------------------------------------------
        >>> ESTILOS COMPARTILHADOS (Do Encontre o Galo) <<<
        --------------------------------------------------------- */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        /* --- Vari√°veis de Cores do Acervo --- */
        :root {
            --primary-color: #005285;   /* Azul Acervo */
            --secondary-color: #EE7D00; /* Laranja Acervo (Destaque/A√ß√£o) */
            --accent-color: #AE1917; /* Vermelho Acervo (Alerta/Status) */
            --background-light: #f4f4f4; /* N√£o √© usado no body, mas √© usado em main */
            --text-dark: #333;
            --text-light: #fff;
            --sombra-card: rgba(0, 0, 0, 0.25);
        }

        /* --- Estilos Globais e Fundo --- */
        body {
            font-family: 'Roboto', sans-serif;
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            
            /* Fundo igual ao do "Encontre o Galo" */
            background-image: url('{% static "meu_app/imagens/acervo_visual/Acervo_vermelho.JPG" %}');
            background-size: cover; 
            background-position: center center; 
            background-attachment: fixed;
            background-color: var(--text-dark);
        }

        h1, h2, h3 {
            font-family: 'Stick No Bills', sans-serif;
            color: var(--primary-color);
            text-transform: uppercase;
            font-weight: 700;
        }

        /* --- CABE√áALHO PADR√ÉO --- */
        header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            text-align: center;
        }

        header h1 {
            color: var(--secondary-color);
            margin: 0;
            font-size: 2em;
        }

        /* --- CONTE√öDO PRINCIPAL (Main Container) --- */
        .game-page-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            width: 100%;
            /* Fundo semi-transparente igual ao do "Encontre o Galo" */
            background-color: rgba(255, 255, 255, 0.95); 
            
            margin: 20px auto; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            max-width: 1200px; /* Aumentado um pouco para caber o mural */
        }
        
        /* --- RODAP√â PADR√ÉO --- */
        footer {
            width: 100%;
            background-color: var(--text-dark); 
            color: var(--text-light); 
            text-align: center;
            padding: 10px 0;
            margin-top: auto; 
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
        }
        footer p {
            margin: 5px 15px;
        }

        /* --- MENSAGEM DE AVISO (Para Telas Pequenas) --- */
        #mobile-warning {
            display: none; /* Controlado pelo Media Query */
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 15px;
            margin: 10px auto;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            max-width: 90%;
        }
        
        /* ---------------------------------------------------------
        >>> ESTILOS ESPEC√çFICOS DO QUEBRA-CABE√áA <<<
        --------------------------------------------------------- */
        
        /* Mural */
        #tela-mural { width: 100%; display:flex; flex-direction:column; align-items:center; }
        .mural { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-bottom:15px; }
        .mural img {
            width: 300px; /* Reduzido para melhor visualiza√ß√£o no container */
            height: 187.5px; /* Mant√©m a propor√ß√£o 16:10 aproximada se o original for 400x250 */
            object-fit: cover; 
            border: 3px solid transparent;
            border-radius: 8px; /* Alterado para 8px para consist√™ncia com main */
            cursor: pointer; 
            transition: transform .2s, border .2s;
            box-shadow: 0 4px 8px var(--sombra-card);
        }
        .mural img.selected { 
            border-color: var(--secondary-color); /* Laranja Acervo */
            transform: scale(1.05); 
        }

        /* Controles */
        .selection-controls, .action-center { 
            display:flex; 
            gap:15px; 
            align-items:center; 
            justify-content:center; 
            flex-wrap:wrap;
            margin-bottom: 20px;
        }
        
        select, button { 
            padding:10px 20px;
            font-size:16px; 
            border-radius:5px; 
            border:1px solid var(--primary-color); 
            font-weight: bold;
            font-family: 'Roboto', sans-serif;
        }
        
        button { 
            background: var(--primary-color); 
            color: var(--text-light); 
            cursor:pointer; 
            transition: background-color 0.3s;
        }
        
        button:hover { 
            background: #003a5b; /* Azul Acervo mais escuro */
        }
        
        /* Jogo */
        #tela-jogo { display:none; width:100%; flex-direction:column; align-items:center; }
        .menu-jogo { display:flex; gap:10px; margin-bottom:15px; }
        
        .board { 
            display:grid; 
            gap:1px; 
            border:4px solid var(--primary-color); 
            background: var(--primary-color); 
            box-shadow: 0 4px 10px var(--sombra-card);
        }
        
        .slot { 
            background: var(--text-light); 
            position:relative; 
        }
        
        .piece { 
            width:100%; 
            height:100%; 
            cursor:grab; 
            background-repeat:no-repeat; 
            transition: opacity .1s; /* Transi√ß√£o para dragging */
        }
        .piece.dragging { opacity:.6; }
        
        #status { 
            margin-top:20px; 
            font-weight:bold; 
            font-family: 'Stick No Bills', sans-serif;
            font-size: 1.8em;
            color: var(--accent-color); /* Vermelho Acervo para destaque */
        }

        /* =========================================================
        >>> RESPONSIVIDADE (C√≥pia do Encontre o Galo) <<<
        ========================================================= */
        @media (max-width: 768px) {
            .game-page-main {
                padding: 10px;
                width: 95%;
                margin: 10px auto;
            }
            .mural img {
                width: 45%;
                height: auto;
            }
            #mobile-warning {
                display: block;
            }
        }
        
        @media (max-width: 500px) {
            .board {
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            #status {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1> QUEBRA-CABE√áAS </h1>
    </header>

    <main class="game-page-main">
        
        <div id="mobile-warning">
            ‚ö†Ô∏è **Aten√ß√£o:** A aplica√ß√£o est√° em desenvolvimento. Para uma melhor experi√™ncia de jogo, utilize uma tela maior.
        </div>
        
        <div id="tela-mural">
            <h2>Escolha sua Obra</h2>
            <div class="mural" id="mural">
                <img src="{% static 'meu_app/imagens/quebra_cabe√ßa/7erros.jpg' %}" 
                    alt="Imagem 1" 
                    data-src="{% static 'meu_app/imagens/quebra_cabe√ßa/7erros.jpg' %}">
                <img src="{% static 'meu_app/imagens/quebra_cabe√ßa/2.jpg' %}" 
                    alt="Imagem 2" 
                    data-src="{% static 'meu_app/imagens/quebra_cabe√ßa/2.jpg' %}">
                <img src="{% static 'meu_app/imagens/quebra_cabe√ßa/3.jpg' %}" 
                    alt="Imagem 3" 
                    data-src="{% static 'meu_app/imagens/quebra_cabe√ßa/3.jpg' %}">
                <img src="{% static 'meu_app/imagens/quebra_cabe√ßa/4.jpg' %}" 
                    alt="Imagem 4" 
                    data-src="{% static 'meu_app/imagens/quebra_cabe√ßa/4.jpg' %}">
                <img src="{% static 'meu_app/imagens/quebra_cabe√ßa/5.jpg' %}" 
                    alt="Imagem 5" 
                    data-src="{% static 'meu_app/imagens/quebra_cabe√ßa/5.jpg' %}">
                <img src="{% static 'meu_app/imagens/quebra_cabe√ßa/6.jpg' %}" 
                    alt="Imagem 6" 
                    data-src="{% static 'meu_app/imagens/quebra_cabe√ßa/6.jpg' %}">
            </div>

            <div class="selection-controls">
                <div class="difficulty-group">
                    <label for="difficulty" style="font-weight: bold;">Dificuldade:</label>
                    <select id="difficulty">
                        <option value="facil">F√°cil (Menos Pe√ßas)</option>
                        <option value="medio" selected>Normal (Padr√£o)</option>
                        <option value="dificil">Dif√≠cil (Mais Pe√ßas)</option>
                    </select>
                </div>
            </div>
            <div class="action-center">
                <button id="jogar">Jogar</button>
                <button id="inicio">Menu Principal</button>
            </div>
        </div>

        <div id="tela-jogo">
            <div class="menu-jogo">
                <button id="voltar">‚Üê Voltar</button>
            </div>
            <div class="board" id="board"></div>
            <p id="status"></p>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Acervo Art√≠stico - UFSM</p>
    </footer>

    <script>
        // --- C√ìDIGO JAVASCRIPT (L√≥gica Original Mantida) ---
        const mural = document.getElementById('mural');
        const telaMural = document.getElementById('tela-mural');
        const telaJogo = document.getElementById('tela-jogo');
        const jogarBtn = document.getElementById('jogar');
        const voltarBtn = document.getElementById('voltar');
        const inicioBtn = document.getElementById('inicio');
        const difficultySelect = document.getElementById('difficulty');
        const board = document.getElementById('board');
        const status = document.getElementById('status');

        let slots = [];
        let currentImage = null;
        let rows = 4, cols = 6;
        let tileSize = 100; // Tamanho base da pe√ßa em pixels

        // ----- Sele√ß√£o do mural -----
        mural.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG') {
                document.querySelectorAll('.mural img').forEach(img => img.classList.remove('selected'));
                e.target.classList.add('selected');
                currentImage = e.target.dataset.src;
            }
        });

        // ----- Navega√ß√£o -----
        jogarBtn.addEventListener('click', () => {
            if (!currentImage) { alert('Selecione uma imagem antes de jogar!'); return; }
            const img = new Image();
            img.onload = function() {
                // C√°lculo de tamanho da pe√ßa e tabuleiro para melhor ajuste na tela
                const maxBoardWidth = Math.min(1100, window.innerWidth - 40); // Limite m√°ximo para o tabuleiro
                
                let tempRows, tempCols;
                const difficulty = difficultySelect.value;
                const ratio = img.width / img.height;

                if (difficulty === 'facil') {
                    tempCols = ratio > 1 ? 5 : ratio < 1 ? 3 : 4;
                    tempRows = Math.round(tempCols / ratio);
                    if(ratio > 1 && tempRows > 4) tempRows = 4; // Limita em 4 linhas se for muito horizontal
                } else if (difficulty === 'medio') {
                    tempCols = ratio > 1 ? 6 : ratio < 1 ? 4 : 5;
                    tempRows = Math.round(tempCols / ratio);
                    if(ratio > 1 && tempRows > 5) tempRows = 5; // Limita em 5 linhas se for muito horizontal
                } else { // dificil
                    tempCols = ratio > 1 ? 7 : ratio < 1 ? 5 : 6;
                    tempRows = Math.round(tempCols / ratio);
                    if(ratio > 1 && tempRows > 6) tempRows = 6; // Limita em 6 linhas se for muito horizontal
                }

                // Garante um n√∫mero m√≠nimo de linhas e colunas
                rows = Math.max(3, tempRows);
                cols = Math.max(3, tempCols);
                
                // Calcula o tamanho ideal da pe√ßa para caber no container
                tileSize = Math.floor(maxBoardWidth / cols);
                if (tileSize > 120) tileSize = 120; // Limite m√°ximo para a pe√ßa

                telaMural.style.display = 'none';
                telaJogo.style.display = 'flex';
                init(currentImage);
            };
            img.src = currentImage;
        });

        voltarBtn.addEventListener('click', () => {
            telaJogo.style.display = 'none';
            telaMural.style.display = 'flex';
            board.innerHTML = '';
            status.textContent = '';
            slots = [];
        });

        // URL 'index.html' assumida como Menu Principal
        inicioBtn.addEventListener('click', () => { window.location.href = '{% url "index" %}'; }); 

        // ----- Inicializa sele√ß√£o padr√£o -----
        window.onload = () => {
            const firstImg = mural.querySelector('img');
            firstImg.classList.add('selected');
            currentImage = firstImg.dataset.src;
            setupDragDrop();
        };

        // ----- Cria√ß√£o do tabuleiro e pe√ßas -----
        function init(imageSrc) {
            board.innerHTML = '';
            slots = [];
            status.textContent = '';

            board.style.gridTemplateColumns = `repeat(${cols}, ${tileSize}px)`;
            board.style.gridTemplateRows = `repeat(${rows}, ${tileSize}px)`;
            
            createBoard();
            const pieces = createPieces(imageSrc);
            shuffle(pieces);
            slots.forEach((slot, i) => slot.appendChild(pieces[i]));

            void board.offsetHeight; // For√ßa o reflow
        }

        function createBoard() {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const slot = document.createElement('div');
                    slot.classList.add('slot');
                    slot.style.width = tileSize + 'px';
                    slot.style.height = tileSize + 'px';
                    slot.dataset.correct = r * cols + c;
                    board.appendChild(slot);
                    slots.push(slot);
                }
            }
        }

        function createPieces(imageSrc) {
            const pieces = [];
            const bgW = cols * tileSize;
            const bgH = rows * tileSize;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const idx = r * cols + c;
                    const piece = document.createElement('div');
                    piece.classList.add('piece');
                    piece.style.backgroundImage = `url("${imageSrc}")`;
                    piece.style.backgroundPosition = `-${c * tileSize}px -${r * tileSize}px`;
                    piece.style.backgroundSize = `${bgW}px ${bgH}px`;
                    piece.draggable = true;
                    piece.dataset.index = idx;
                    pieces.push(piece);
                }
            }
            return pieces;
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        // ----- Drag & Drop: registrado apenas 1 vez (L√≥gica Original Mantida) -----
        let dragSetupDone = false;
        let dragged = null;

        function setupDragDrop() {
            if (dragSetupDone) return;
            dragSetupDone = true;

            // dragstart
            board.addEventListener('dragstart', (e) => {
                const t = e.target;
                if (t && t.classList && t.classList.contains('piece')) {
                    dragged = t;
                    t.classList.add('dragging');
                    // Adicionar um pequeno atraso para permitir que a opacidade seja aplicada antes do drag.
                    setTimeout(() => t.style.opacity = '0.5', 0);
                }
            });

            // dragend
            board.addEventListener('dragend', (e) => {
                if (dragged) {
                    dragged.classList.remove('dragging');
                    dragged.style.opacity = '1';
                    dragged = null;
                }
            });

            // dragover - permitir drop
            board.addEventListener('dragover', (e) => { e.preventDefault(); });

            // drop (delegado)
            board.addEventListener('drop', (e) => {
                e.preventDefault();
                const targetSlot = e.target.closest('.slot');
                if (!targetSlot) return;
                if (!dragged) return;

                if (!targetSlot.firstChild) {
                    targetSlot.appendChild(dragged);
                } else if (targetSlot.firstChild !== dragged) {
                    const other = targetSlot.firstChild;
                    const fromSlot = dragged.parentElement;
                    targetSlot.appendChild(dragged);
                    fromSlot.appendChild(other);
                }
                checkWin();
            });
        }

        // ----- Verifica√ß√£o de vit√≥ria -----
        function checkWin() {
            const ok = slots.every(slot => {
                if (!slot.firstChild) return false;
                return slot.dataset.correct === slot.firstChild.dataset.index;
            });
            if (ok) {
                status.textContent = 'üéâ Parab√©ns! Voc√™ completou o quebra-cabe√ßa!';
                // Opcional: Desabilitar o Drag & Drop ap√≥s a vit√≥ria
                document.querySelectorAll('.piece').forEach(p => p.draggable = false);
            } else {
                 status.textContent = ''; // Limpa o status se n√£o ganhou
            }
        }
    </script>
</body>
</html>